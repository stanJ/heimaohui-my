package com.xa3ti.blackcat.base.util;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URL;
import java.net.URLConnection;
import java.nio.channels.FileChannel;

import javax.servlet.http.HttpServletResponse;

/**
 * 文件处理工具类
 * 
 * @author zj
 *
 */
public class FileUtil {
	/**
	 * 文件copy方法
	 * 
	 * @param sourceFile
	 *            源文件
	 * @param destFile
	 *            目标文件
	 * @throws IOException
	 */
	public static void copyFile(File sourceFile, File destFile)
			throws IOException {
		if (!destFile.exists()) {
			destFile.createNewFile();
		}

		FileChannel source = null;
		FileChannel destination = null;
		try {
			source = new FileInputStream(sourceFile).getChannel();
			destination = new FileOutputStream(destFile).getChannel();

			// previous code: destination.transferFrom(source, 0,
			// source.size());
			// to avoid infinite loops, should be:
			long count = 0;
			long size = source.size();
			while ((count += destination.transferFrom(source, count, size
					- count)) < size)
				;
		} finally {
			if (source != null) {
				source.close();
			}
			if (destination != null) {
				destination.close();
			}
		}
	}

	/**
	 * 远程文件下载
	 * 
	 * @param urlString
	 *            远程文件url
	 * @param filename
	 *            文件名
	 * @param savePath
	 *            保存路径
	 * @throws Exception
	 */
	public static void download(String urlString, String filename,
			String savePath) throws Exception {
		// 构造URL
		URL url = new URL(urlString);
		// 打开连接
		URLConnection con = url.openConnection();
		// 设置请求超时为5s
		con.setConnectTimeout(5 * 1000);
		// 输入流
		InputStream is = con.getInputStream();

		// 1K的数据缓冲
		byte[] bs = new byte[1024];
		// 读取到的数据长度
		int len;
		// 输出的文件流
		File sf = new File(savePath);
		if (!sf.exists()) {
			sf.mkdirs();
		}
		OutputStream os = new FileOutputStream(sf.getPath() + File.separator
				+ filename);
		// 开始读取
		while ((len = is.read(bs)) != -1) {
			os.write(bs, 0, len);
		}
		// 完毕，关闭所有链接
		os.close();
		is.close();
	}

	/**
	 * 远程文件下载
	 * 
	 * @param urlString
	 *            远程文件url
	 * @param filename
	 *            文件名
	 * @param savePath
	 *            保存路径
	 * @throws Exception
	 */
	public static void download(String urlString, String filename,
			HttpServletResponse response) throws Exception {
		// 构造URL
		URL url = new URL(urlString);
		// 打开连接
		URLConnection con = url.openConnection();
		// 设置请求超时为5s
		con.setConnectTimeout(5 * 1000);
		// 输入流
		InputStream is = con.getInputStream();

		// 1K的数据缓冲
		byte[] bs = new byte[1024];
		// 读取到的数据长度
		int len;

		//response.reset();
		response.addHeader("Content-Disposition", "attachment;filename="
				+ new String(filename.getBytes()));
		

		OutputStream os = new BufferedOutputStream(response.getOutputStream());
		// 开始读取
		Long l=0l;
		while ((len = is.read(bs)) != -1) {
			os.write(bs, 0, len);
			l+=len;
		}
		
		response.addHeader("Content-Length", "" + l);
		// 完毕，关闭所有链接
		os.close();
		is.close();

		response.setContentType("application/octet-stream");

		os.flush();
		os.close();

	}

	public static void main(String[] args) throws Exception {
		// TODO Auto-generated method stub
		download(
				"http://api.map.baidu.com/staticimage?center=118.403874,39.914888&width=300&height=200&zoom=",
				"1.png", "c:\\image\\");
	}
}
